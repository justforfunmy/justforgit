<!DOCTYPE html>
<html lang="en">

<% include head.ejs %>

    <body>
        <div class="container-fluid">
            <header class="flex a-center">
                <h3 class="fg" style="margin:0">new Blog </h3>
                <% if(username){%>
                    <span style="padding:0 15px">
                    <%= username%>
                </span>
                    <button class="btn btn-default btn-sm" id="logout">logout</button>
                    <% } else { %>
                        <a class="btn btn-default btn-sm" href="/views/login">login</a>
                        <% } %>
            </header>
        </div>

        <div class="blogForm">
            <div>
                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" name="title" value="" class="form-control small-ipt">
                </div>
                <div class="form-group">
                    <label for="title">Abstract</label>
                    <input type="text" name="abstract" value="" class="form-control small-ipt">
                </div>
                <div class="form-group">
                    <label for="title">Content</label>
                    <textarea class="form-control" rows="5" id='content'></textarea>
                </div>
                <form class="form-group" enctype="multipart/form-data">
                    <label for="title">Img</label>
                    <input type="hidden" name='image'>
                    <div class="flex  a-center">
                        <input type="file" id="file">
                        <span class="btn btn-default" id="upload">上传</span>
                    </div>
                    <p class="warning"></p>
                </form>
                <div class="form-group">
                    <div class="btn btn-default" id="addNew">提交</div>
                </div>
            </div>
        </div>
        <script src="/javascripts/dateFormat.js"></script>
        <script>
            $(function() {
                $('#upload').on('click', function() {
                    var file = $('#file').get(0).files[0];
                    console.log(file);
                    var formData = new FormData();
                    formData.append('file', file);
                    $.ajax({
                        type: 'POST',
                        url: config.apiUrl + 'upload',
                        data: formData,
                        contentType: false,
                        processData: false,
                        success: function(res) {
                            if (res.code != 1) {
                                $('.warning').text(res.message).show();
                            } else {
                                $('.warning').text(res.message).show();
                                $('input[name="image"]').val(res.fileUrl)
                            }

                        },
                        error: function(err) {
                            console.log(err)
                        }
                    })
                })

                $("#addNew").on('click', function() {
                    $.ajax({
                        url: config.apiUrl + 'blog/add',
                        data: {
                            title: $('input[name="title"]').val(),
                            abstract: $('input[name="abstract"]').val(),
                            content: $('#content').val(),
                            click: Math.floor(Math.random() * 100),
                            image: $('input[name="image"]').val(),
                            createtime: new Date().format('yyyy-MM-dd')
                        },
                        type: 'POST',
                        success: function(res) {
                            console.log(res)
                            if (res.code === 2) {
                                window.location.href = config.apiUrl + 'views/login'
                            } else if (res.code === 1) {
                                window.location.href = config.apiUrl + 'views/blog'
                            } else {
                                console.log(res)
                            }
                        },
                        error: function(err) {
                            console.log(err)
                        }
                    })
                })
            })


            function dateFormat(date) {}
        </script>

    </body>

</html>